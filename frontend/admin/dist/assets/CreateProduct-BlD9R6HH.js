import{g as z,r as y,w as D,y as G,z as L,s as W,o as v,h as M,i as q,u as e,c as F,b as c,m as H,j as h,e as I,t as J,f as K}from"./index-DRUAnB2R.js";import{_ as Q,a as X}from"./PageBreadcrumb.vue_vue_type_script_setup_true_lang-DgEqRBaQ.js";import{u as Y,a as Z}from"./useCategories-D_7NGOD-.js";import{u as R,a as U,b as ee,_ as te,c as re,d as se,e as ae}from"./useProductValidation-BnqKeXyH.js";import{a as oe,u as ne}from"./useProductAlerts-C8_6JnZL.js";function le(){const C=z(),{createProduct:x}=oe(),{categories:o,fetchCategories:f,fetchCategoryAttributes:k}=Y(),{brands:j,fetchAllBrands:m}=R(),{colors:E,fetchAllColors:A}=U(),{alerts:b,showAlert:i}=ne(),a=y({id:null,article:"",name:"",slug:"",price:0,unit:"шт",product_code:"",description:"",category_id:"",color_id:"",brand_id:"",is_published:!0,is_sale:!1,texture:"",pattern:"",country:"",collection:"",attribute_values:[],images:[]}),g=y(!1),d=y(!1),B=y(null),P=()=>{d.value=!1},V=async(s,w,u,N)=>{s();const O=Object.values(u).filter(n=>n);for(const n of a.value.attribute_values)n.error&&O.push(n.error);if(O.length>0){O.forEach(n=>{i("error","Ошибка валидации",n)});return}b.value=[];try{g.value=!0;const n=(N==null?void 0:N.newFiles)||[],l=await x(a.value,n);l.success?C.push("/products?success=created"):l.errors?(Object.keys(u).forEach(r=>{u[r]=""}),a.value.attribute_values.forEach(r=>{r.error=""}),Object.keys(l.errors).forEach(r=>{r in u&&l.errors[r]&&(u[r]=l.errors[r][0])}),Object.keys(l.errors).forEach(r=>{if(r.startsWith("attribute_values.")&&l.errors[r]){const p=r.split(".");if(p.length>=3){const T=parseInt(p[1]),S=p[2];(S==="string_value"||S==="number_value"||S==="boolean_value")&&a.value.attribute_values[T]&&(a.value.attribute_values[T].error=l.errors[r][0])}}}),Object.values(l.errors).forEach(r=>{Array.isArray(r)?r.forEach(p=>{i("error","Ошибка валидации",p)}):i("error","Ошибка валидации",r)}),i("error","Ошибка валидации","Пожалуйста, исправьте ошибки в форме")):i("error","Ошибка","Не удалось создать товар")}catch(n){i("error","Ошибка","Не удалось создать товар"),console.error("Error creating product:",n)}finally{g.value=!1}},$=()=>{C.push("/products")},_=async s=>{if(!s){a.value.attribute_values=[];return}try{const w=await k(Number(s));a.value.attribute_values=w.map(u=>({attribute_id:u.id,attribute:u,string_value:"",number_value:null,boolean_value:!1,text_value:"",error:""}))}catch(w){console.error("Ошибка загрузки атрибутов:",w),a.value.attribute_values=[]}};return{product:a,loading:g,error:d,alert:B,alerts:b,categories:o,brands:j,colors:E,handleFetchProducts:P,handleSubmit:V,goBack:$,init:()=>{f(),m(),A(),D(()=>a.value.category_id,s=>{_(s)})}}}const ie={key:0,class:"flex justify-center items-center h-screen"},ue={key:1,class:"flex flex-col justify-center items-center h-screen font-bold text-error-700 text-theme-xl dark:text-error-500"},ce={key:2},de={class:"flex flex-col gap-3 sm:flex-row sm:justify-end"},fe=["disabled"],me="Создание нового товара",he=G({__name:"CreateProduct",setup(C){const x=y(),{product:o,loading:f,error:k,alerts:j,categories:m,brands:E,colors:A,handleFetchProducts:b,handleSubmit:i,goBack:a,init:g}=le(),{errors:d,validateAll:B,hasErrors:P}=ee(o),V=L(()=>{if(!o.value.category_id)return!1;const _=m.value.find(s=>s.value===Number(o.value.category_id));if(!_)return!1;const t=_.label.toLowerCase();return t.includes("керамогранит")||t.includes("плитка")||t.includes("мозаика")||t.includes("клинкер")||t.includes("ступени")}),$=()=>{i(B,P,d,x.value)};return W(()=>{g()}),(_,t)=>(v(),M(X,null,{default:q(()=>[e(f)?(v(),F("div",ie,t[3]||(t[3]=[c("div",{class:"animate-spin rounded-full h-16 w-16 border-b-2 border-brand-500"},null,-1)]))):e(k)?(v(),F("div",ue,[t[4]||(t[4]=H(" Ошибка при загрузке")),t[5]||(t[5]=c("br",null,null,-1)),c("button",{class:"inline-flex items-center justify-center font-medium gap-2 rounded-lg transition px-4 py-3 text-sm bg-brand-500 text-white shadow-theme-xs hover:bg-brand-600 disabled:bg-brand-300 mt-2",onClick:t[0]||(t[0]=(...s)=>e(b)&&e(b)(...s))}," Попробовать снова ")])):(v(),F("div",ce,[h(Q,{pageTitle:me}),c("form",{onSubmit:K($,["prevent"]),class:"space-y-6"},[h(te,{product:e(o),errors:e(d),categories:e(m),brands:e(E),colors:e(A)},null,8,["product","errors","categories","brands","colors"]),h(re,{product:e(o),errors:e(d),categories:e(m),"is-ceramic-category":V.value},null,8,["product","errors","categories","is-ceramic-category"]),e(o).attribute_values.length!==0?(v(),M(se,{key:0,product:e(o)},null,8,["product"])):I("",!0),h(ae,{ref_key:"imageUploadRef",ref:x,modelValue:e(o).images,"onUpdate:modelValue":t[1]||(t[1]=s=>e(o).images=s)},null,8,["modelValue"]),c("div",de,[c("button",{onClick:t[2]||(t[2]=(...s)=>e(a)&&e(a)(...s)),class:"shadow-theme-xs inline-flex items-center justify-center gap-2 rounded-lg bg-white px-4 py-3 text-sm font-medium text-gray-700 ring-1 ring-gray-300 transition hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-400 dark:ring-gray-700 dark:hover:bg-white/[0.03]"}," Отмена "),c("button",{type:"submit",disabled:e(f),class:"bg-brand-500 shadow-theme-xs hover:bg-brand-600 inline-flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition"},J(e(f)?"Создание...":"Создать товар"),9,fe)])],32)])),h(Z,{alerts:e(j)},null,8,["alerts"])]),_:1}))}});export{he as default};
