import{r as c,i as H,g as T}from"./index-CHHwKtwZ.js";const _="http://127.0.0.1:8000";function C(){const j=c([]),$=c(!1),P=c(null),i=c({key:null,asc:!0}),p=c(1),w=c(50),y=c(0),S=H(()=>Math.ceil(y.value/w.value)),b=c(""),g=c(null),d=c({sale:{true:!0,false:!0},published:{true:!0,false:!0}}),U=H(()=>{const t=S.value,a=p.value,r=2,s=[],e=[];for(let o=Math.max(2,a-r);o<=Math.min(t-1,a+r);o++)s.push(o);return a-r>2?e.push(1,"..."):e.push(1),e.push(...s),a+r<t-1?e.push("...",t):t>1&&e.push(t),e}),A=new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB"}),v=async()=>{$.value=!0,P.value=null;const t=new URLSearchParams({page:p.value.toString(),per_page:w.value.toString()});i.value.key&&(t.append("sort_key",i.value.key),t.append("sort_direction",i.value.asc?"asc":"desc")),g.value&&t.append("category_id",g.value.value.toString()),b.value.trim()&&t.append("search",b.value.trim());const a=Object.keys(d.value.sale).filter(e=>d.value.sale[e]);a.length>0&&a.forEach(e=>t.append("is_sale[]",e));const r=Object.keys(d.value.published).filter(e=>d.value.published[e]);r.length>0&&r.forEach(e=>t.append("is_published[]",e));const s=`${_}/api/products?${t.toString()}`;try{const e=await fetch(s);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const o=await e.json();j.value=o.products.data,y.value=o.products.total}catch(e){P.value=e.message,console.error("Ошибка загрузки товаров:",e)}finally{$.value=!1}},R=t=>{i.value.key===t?i.value.asc=!i.value.asc:(i.value.key=t,i.value.asc=!0),v()},B=()=>{p.value>1&&(p.value--,v())},I=()=>{p.value<S.value&&(p.value++,v())},L=t=>{p.value=t,v()},M=async t=>{try{const a=await fetch(`${_}/api/products/${t}`,{method:"DELETE"});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return!0}catch(a){return console.error("Ошибка удаления товара:",a),!1}},k=async t=>{try{const a=await fetch(`${_}/api/products/${t}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return(await a.json()).product}catch(a){throw console.error("Ошибка загрузки товара:",a),a}},G=async(t,a,r)=>{try{const s=new FormData;Object.keys(a).forEach(o=>{var n;o==="images"?a.images.forEach((u,l)=>{var f;s.append(`images[${l}][id]`,((f=u.id)==null?void 0:f.toString())||""),s.append(`images[${l}][sort_order]`,u.sort_order.toString())}):o==="attribute_values"?a.attribute_values.forEach((u,l)=>{var f,h,O;s.append(`attribute_values[${l}][attribute_id]`,((f=u.attribute_id)==null?void 0:f.toString())||""),s.append(`attribute_values[${l}][string_value]`,u.string_value||""),s.append(`attribute_values[${l}][number_value]`,((h=u.number_value)==null?void 0:h.toString())||""),s.append(`attribute_values[${l}][text_value]`,u.text_value||""),typeof u.boolean_value=="boolean"?s.append(`attribute_values[${l}][boolean_value]`,u.boolean_value?"1":"0"):s.append(`attribute_values[${l}][boolean_value]`,((O=u.boolean_value)==null?void 0:O.toString())||"")}):typeof a[o]=="boolean"?s.append(o,a[o]?"1":"0"):s.append(o,((n=a[o])==null?void 0:n.toString())||"")}),s.append("_method","PUT"),r&&r.length>0&&r.forEach((o,n)=>{s.append(`new_images[${n}]`,o)});const e=await fetch(`${_}/api/products/${t}`,{method:"POST",headers:{Accept:"application/json"},body:s});if(e.ok)return{success:!0};if(e.status===422)return{success:!1,errors:(await e.json()).errors};throw new Error(`HTTP error! status: ${e.status}`)}catch(s){return console.error("Ошибка обновления товара:",s),{success:!1}}},m=()=>{p.value=1};let E=null;return T(b,t=>{E&&clearTimeout(E),E=setTimeout(()=>{m(),v()},500)}),T(()=>d.value,()=>{m(),v()},{deep:!0}),T(g,()=>{m(),v()}),{products:j,loading:$,error:P,sort:i,page:p,itemsPerPage:w,totalItems:y,totalPages:S,searchQuery:b,selectedCategory:g,filters:d,visiblePages:U,formatter:A,fetchProducts:v,handleSortBy:R,handlePrevPage:B,handleNextPage:I,handleGoToPage:L,deleteProduct:M,getProduct:k,updateProduct:G,createProduct:async(t,a)=>{try{const r=new FormData;Object.keys(t).forEach(e=>{var o;e==="images"?t.images.forEach((n,u)=>{var l;r.append(`images[${u}][id]`,((l=n.id)==null?void 0:l.toString())||""),r.append(`images[${u}][sort_order]`,n.sort_order.toString())}):e==="attribute_values"?t.attribute_values.forEach((n,u)=>{var l,f,h;r.append(`attribute_values[${u}][attribute_id]`,((l=n.attribute_id)==null?void 0:l.toString())||""),r.append(`attribute_values[${u}][string_value]`,n.string_value||""),r.append(`attribute_values[${u}][number_value]`,((f=n.number_value)==null?void 0:f.toString())||""),r.append(`attribute_values[${u}][text_value]`,n.text_value||""),typeof n.boolean_value=="boolean"?r.append(`attribute_values[${u}][boolean_value]`,n.boolean_value?"1":"0"):r.append(`attribute_values[${u}][boolean_value]`,((h=n.boolean_value)==null?void 0:h.toString())||"")}):typeof t[e]=="boolean"?r.append(e,t[e]?"1":"0"):r.append(e,((o=t[e])==null?void 0:o.toString())||"")}),a&&a.length>0&&a.forEach((e,o)=>{r.append(`new_images[${o}]`,e)});const s=await fetch(`${_}/api/products`,{method:"POST",headers:{Accept:"application/json"},body:r});if(s.ok)return{success:!0};if(s.status===422)return{success:!1,errors:(await s.json()).errors};throw new Error(`HTTP error! status: ${s.status}`)}catch(r){return console.error("Ошибка создания товара:",r),{success:!1}}},resetPage:m}}export{C as u};
