import{j as G,h as L,r as B,w as W,z as H,c as J,i as K,o as y,k as q,l as Q,u as t,b as $,d as p,s as R,m as P,f as U,t as X,g as Y}from"./index-CEEZRwKY.js";import{_ as Z,a as ee}from"./PageBreadcrumb.vue_vue_type_script_setup_true_lang-BipWElk8.js";import{u as te,a as re}from"./useCategories-DcWD2FtS.js";import{u as ae,a as se,b as oe,_ as le,c as ue,d as ie,e as ne}from"./useProductValidation-D0W1B4om.js";import{a as ce,u as de}from"./useProductAlerts-CkjHmGOg.js";import"./useAuth-CEw0P2Z7.js";function fe(){const O=G(),x=L(),{getProduct:o,updateProduct:g}=ce(),{allCategories:S,categories:T,fetchCategories:w,fetchCategoryAttributes:F}=te(),{brands:I,fetchAllBrands:k}=ae(),{colors:M,fetchAllColors:C}=se(),{alerts:N,showAlert:l}=de(),r=B({id:null,article:"",name:"",slug:"",price:0,unit:"шт",product_code:"",description:"",category_id:"",color_id:"",brand_id:"",is_published:!0,is_sale:!1,texture:"",pattern:"",country:"",collection:"",attribute_values:[],images:[]}),f=B(!0),h=B(!1),A=B(null),b=async()=>{try{f.value=!0,h.value=!1;const n=await o(Number(O.params.id));r.value={...n},r.value.attribute_values=r.value.attribute_values.filter((m,d,v)=>v.findIndex(u=>u.attribute_id===m.attribute_id)===d),r.value.attribute_values.forEach(m=>{m.error=""}),await k(),await C(),r.value.category_id&&await D(r.value.category_id)}catch(n){h.value=!0,l("error","Ошибка","Не удалось загрузить товар"),console.error("Error loading product:",n)}finally{f.value=!1}},a=()=>{h.value=!1,b()},c=async(n,m,d,v)=>{n();const u=Object.values(d).filter(e=>e);for(const e of r.value.attribute_values)e.error&&u.push(e.error);if(u.length>0){u.forEach(e=>{l("error","Ошибка валидации",e)});return}N.value=[];try{f.value=!0;const e=(v==null?void 0:v.newFiles)||[],E={...r.value,attribute_values:r.value.attribute_values.filter((s,_,V)=>V.findIndex(j=>j.attribute_id===s.attribute_id)===_)},i=await g(Number(O.params.id),E,e);i.success?x.push("/products?success=updated"):i.errors?(Object.keys(d).forEach(s=>{d[s]=""}),r.value.attribute_values.forEach(s=>{s.error=""}),Object.keys(i.errors).forEach(s=>{s in d&&i.errors[s]&&(d[s]=i.errors[s][0])}),Object.keys(i.errors).forEach(s=>{if(s.startsWith("attribute_values.")&&i.errors[s]){const _=s.split(".");if(_.length>=3){const V=parseInt(_[1]),j=_[2];(j==="string_value"||j==="number_value"||j==="boolean_value")&&r.value.attribute_values[V]&&(r.value.attribute_values[V].error=i.errors[s][0])}}}),Object.values(i.errors).forEach(s=>{Array.isArray(s)?s.forEach(_=>{l("error","Ошибка валидации",_)}):l("error","Ошибка валидации",s)}),l("error","Ошибка валидации","Пожалуйста, исправьте ошибки в форме")):l("error","Ошибка","Не удалось обновить товар")}catch(e){l("error","Ошибка","Не удалось обновить товар"),console.error("Error updating product:",e)}finally{f.value=!1}},z=()=>{x.push("/products")},D=async n=>{if(!n){r.value.attribute_values=[];return}try{const d=(await F(Number(n))).filter((u,e,E)=>E.findIndex(i=>i.id===u.id)===e),v=r.value.attribute_values;r.value.attribute_values=d.map(u=>{const e=v.find(E=>E.attribute_id===u.id);return{id:(e==null?void 0:e.id)||null,attribute_id:u.id,attribute:u,string_value:(e==null?void 0:e.string_value)||"",number_value:(e==null?void 0:e.number_value)||null,boolean_value:(e==null?void 0:e.boolean_value)||!1,text_value:(e==null?void 0:e.text_value)||"",error:""}})}catch(m){console.error("Ошибка загрузки атрибутов:",m),r.value.attribute_values=[]}};return{product:r,loading:f,error:h,alert:A,alerts:N,categories:T,brands:I,colors:M,loadProduct:b,handleFetchProducts:a,handleSubmit:c,goBack:z,init:async()=>{await w(),await k(),await C(),await b(),W(()=>r.value.category_id,n=>{D(n)})}}}const be={key:0,class:"flex justify-center items-center h-screen"},me={key:1,class:"flex flex-col justify-center items-center h-screen font-bold text-error-700 text-theme-xl dark:text-error-500"},ve={key:2,class:"flex flex-col justify-center items-center h-screen menu-item-icon-active text-center font-bold text-theme-xl m-5"},_e={key:3},pe={class:"flex flex-col gap-3 sm:flex-row sm:justify-end"},ge=["disabled"],he="Редактирование товара арт. ",Pe=H({__name:"EditProduct",setup(O){const x=B(),{product:o,loading:g,error:S,alerts:T,categories:w,brands:F,colors:I,handleFetchProducts:k,handleSubmit:M,goBack:C,init:N}=fe(),{errors:l,validateAll:r,hasErrors:f}=oe(o),h=J(()=>{if(!o.value.category_id)return!1;const b=w.value.find(c=>c.value===Number(o.value.category_id));if(!b)return!1;const a=b.label.toLowerCase();return a.includes("керамогранит")||a.includes("плитка")||a.includes("мозаика")||a.includes("клинкер")||a.includes("ступени")}),A=()=>{M(r,f,l,x.value)};return K(()=>{N()}),(b,a)=>(y(),q(ee,null,{default:Q(()=>[t(g)?(y(),$("div",be,a[3]||(a[3]=[p("div",{class:"animate-spin rounded-full h-16 w-16 border-b-2 border-brand-500"},null,-1)]))):t(S)?(y(),$("div",me,[a[4]||(a[4]=R(" Ошибка при загрузке")),a[5]||(a[5]=p("br",null,null,-1)),p("button",{class:"inline-flex items-center justify-center font-medium gap-2 rounded-lg transition px-4 py-3 text-sm bg-brand-500 text-white shadow-theme-xs hover:bg-brand-600 disabled:bg-brand-300 mt-2",onClick:a[0]||(a[0]=(...c)=>t(k)&&t(k)(...c))}," Попробовать снова ")])):!t(g)&&!t(S)&&!t(o).id?(y(),$("div",ve," Товар не найден ")):(y(),$("div",_e,[P(Z,{pageTitle:he+t(o).article},null,8,["pageTitle"]),p("form",{onSubmit:Y(A,["prevent"]),class:"space-y-6"},[P(le,{product:t(o),errors:t(l),categories:t(w),brands:t(F),colors:t(I)},null,8,["product","errors","categories","brands","colors"]),P(ue,{product:t(o),errors:t(l),categories:t(w),"is-ceramic-category":h.value},null,8,["product","errors","categories","is-ceramic-category"]),t(o).attribute_values.length!==0?(y(),q(ie,{key:0,product:t(o)},null,8,["product"])):U("",!0),P(ne,{ref_key:"imageUploadRef",ref:x,modelValue:t(o).images,"onUpdate:modelValue":a[1]||(a[1]=c=>t(o).images=c)},null,8,["modelValue"]),p("div",pe,[p("button",{onClick:a[2]||(a[2]=(...c)=>t(C)&&t(C)(...c)),class:"shadow-theme-xs inline-flex items-center justify-center gap-2 rounded-lg bg-white px-4 py-3 text-sm font-medium text-gray-700 ring-1 ring-gray-300 transition hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-400 dark:ring-gray-700 dark:hover:bg-white/[0.03]"}," Отмена "),p("button",{type:"submit",disabled:t(g),class:"bg-brand-500 shadow-theme-xs hover:bg-brand-600 inline-flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-white transition"},X(t(g)?"Сохранение...":"Сохранить"),9,ge)])],32)])),P(re,{alerts:t(T)},null,8,["alerts"])]),_:1}))}});export{Pe as default};
